<?xml version="1.0" encoding="UTF-8"?>

<metamorph xmlns="http://www.culturegraph.org/metamorph" version="1">

    <vars>
        <var name="swissbib_domain" value="http://data.swissbib.ch/resource/"/>
    </vars>

    <rules>

        <!-- Set id -->
        <data source="001" name="_id"/>

        <data source="001" name="\@id">
            <compose prefix="http://data.swissbib.ch/resource/"/>
            <compose postfix="/about"/>
        </data>

        <!--RDF TYPE (CLASS)-->

        <data source="_id" name="\@type">
            <constant value="http://purl.org/ontology/bibo/document"/>
        </data>

        <!--REFERENCED JSON-LD CONTEXT-->
        <data source="_id" name="\@context">
            <constant value="http://data.swissbib.ch/document/context.jsonld"/>
        </data>

        <!-- Definitions for recursions to be used later in substructures (must be set here!) -->

        <data source="008" name="@language">
            <substring start="35" end="38"/>
        </data>

        <combine name="@key1000" value="${name}##${number}##${title}##${lifedata}##${fullname}" flushWith="1000 ">
            <data source="1000 .a" name="name"/>
            <data source="1000 .b" name="number"/>
            <data source="1000 .c" name="title"/>
            <data source="1000 .d" name="lifedata"/>
            <data source="1000 .q" name="fullname"/>
            <postprocess>
                <java class="org.swissbib.linked.mf.morph.functions.AuthorHash"/>
            </postprocess>
        </combine>
        <combine name="@key1001" value="${lastname}##${firstname}##${number}##${title}##${lifedata}##${fullname}"
                 flushWith="1001 ">
            <data source="1001 .a" name="lastname"/>
            <data source="1001 .D" name="firstname"/>
            <data source="1001 .b" name="number"/>
            <data source="1001 .c" name="title"/>
            <data source="1001 .d" name="lifedata"/>
            <data source="1001 .q" name="fullname"/>
            <postprocess>
                <java class="org.swissbib.linked.mf.morph.functions.AuthorHash"/>
            </postprocess>
        </combine>
        <combine name="@key7000" value="${name}##${number}##${title}##${lifedata}##${fullname}" flushWith="7000 ">
            <data source="7000 .a" name="name"/>
            <data source="7000 .b" name="number"/>
            <data source="7000 .c" name="title"/>
            <data source="7000 .d" name="lifedata"/>
            <data source="7000 .q" name="fullname"/>
            <postprocess>
                <java class="org.swissbib.linked.mf.morph.functions.AuthorHash"/>
            </postprocess>
        </combine>
        <combine name="@key7001" value="${lastname}##${firstname}##${number}##${title}##${lifedata}##${fullname}"
                 flushWith="7001 ">
            <data source="7001 .a" name="lastname"/>
            <data source="7001 .D" name="firstname"/>
            <data source="7001 .b" name="number"/>
            <data source="7001 .c" name="title"/>
            <data source="7001 .d" name="lifedata"/>
            <data source="7001 .q" name="fullname"/>
            <postprocess>
                <java class="org.swissbib.linked.mf.morph.functions.AuthorHash"/>
            </postprocess>
        </combine>
        <combine name="@key710" value="${name}##${subunit}##${number}##${date}##${location}" flushWith="710??">
            <data source="710??.a" name="name"/>
            <data source="710??.b" name="subunit"/>
            <data source="710??.n" name="number"/>
            <data source="710??.d" name="date"/>
            <data source="710??.c" name="location"/>
            <postprocess>
                <java class="org.swissbib.linked.mf.morph.functions.AuthorHash"/>
            </postprocess>
        </combine>
        <combine name="@key711" value="${name}##${subunit}##${number}##${date}##${location}" flushWith="711??">
            <data source="710??.a" name="name"/>
            <data source="710??.e" name="subunit"/>
            <data source="710??.n" name="number"/>
            <data source="710??.d" name="date"/>
            <data source="710??.c" name="location"/>
            <postprocess>
                <java class="org.swissbib.linked.mf.morph.functions.AuthorHash"/>
            </postprocess>
        </combine>

        <!--BUILD BULK API HEADER FOR TYPE "DOCUMENT"-->

        <!--BUILD THE RECORD "ABOUT"-->

        <!--		<entity name="&#45;&#45;" flushWith="record" >-->
        <!--To define the subject (root element) of each record.
        "entity" makes it possible to create a hierarchical tag structure.
        "flushWith" enables to group various subfields into one output, even if the field appears more than one time. -->

        <!--PUBLICATION DATE OF THE RDF RECORD-->
        <entity name="dct:issued">
            <data name="@type" source="_id">
                <constant value="http://www.w3.org/2001/XMLSchema#dateTime"/>
            </data>
            <data name="@value" source="_id">
                <timestamp format="yyyy-MM-dd'T'HH:mm:ss.SSSXXX"/>
            </data>
        </entity>

        <!--LAST MODIFICATION DATE OF THE MARC RECORD-->
        <data name="dct:modified" source="005">
            <regexp match="^(\d\d\d\d)(\d\d)(\d\d)(\d\d)(\d\d)(\d\d)\.(\d)"
                    format="${1}-${2}-${3}T${4}:${5}:${6}+01:00"/>
        </data>

        <!--NETWORK(S) THAT CREATED THE RECORD-->
        <data source="035  .a" name="dct:contributor">
            <regexp match="\((.*)\)" format="${1}"/>
            <lookup in="networks"/>
            <unique part="value"/>
        </data>

        <data source="035  .a" name="dc:contributor">
            <!--rule for the case where the network is not in the lookup here above-->
            <regexp match="\((.*)\)" format="${1}"/>
            <blacklist>
                <entry name="ABN"/>
                <entry name="ALEX"/>
                <entry name="BGR"/>
                <entry name="BORIS"/>
                <entry name="CCSA"/>
                <entry name="CH-CCSA"/>
                <entry name="DDB"/>
                <entry name="DE-599"/>
                <entry name="ECOD"/>
                <entry name="IDSBB"/>
                <entry name="IDSLU"/>
                <entry name="IDSSG"/>
                <entry name="IDSSG2"/>
                <entry name="LIBIB"/>
                <entry name="NEBIS"/>
                <entry name="OCoLC"/>
                <entry name="RERO"/>
                <entry name="RETROS"/>
                <entry name="SBT"/>
                <entry name="SERVAL"/>
                <entry name="SGBN"/>
                <entry name="SLB"/>
                <entry name="SNL"/>
                <entry name="Sz"/>
                <entry name="ZORA"/>
            </blacklist>
        </data>

        <!--LOCAL ID OF THE RESOURCE-->
        <data source="035  .a" name="bf:local">
            <regexp match="\((.*)\)(.*)" format="${1}/${2}"/>
            <unique part="value"/>
        </data>

        <!--LINK WITH THE BASIS RECORD-->
        <data source="001" name="foaf:primaryTopic">
            <compose prefix="http://data.swissbib.ch/resource/"/>
            <compose postfix="/about"/>
        </data>


        <!--		</entity>-->
    </rules>

    <maps>
        <filemap name="cantons" files="./src/main/resources/transformation/resource/maps/cantons.txt" separator="\t"/>
        <filemap name="languages" files="./src/main/resources/transformation/resource/maps/languages.txt"
                 separator="\t"/>
        <filemap name="countries" files="./src/main/resources/transformation/resource/maps/countries.txt"
                 separator="\t"/>
        <filemap name="networks" files="./src/main/resources/transformation/resource/maps/networks.txt" separator="\t"/>
        <filemap name="type_content" files="./src/main/resources/transformation/resource/maps/type_content.txt"
                 separator="\t"/>
        <filemap name="type_media" files="./src/main/resources/transformation/resource/maps/type_media.txt"
                 separator="\t"/>
    </maps>

</metamorph>
