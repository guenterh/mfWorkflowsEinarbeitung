<?xml version="1.0" encoding="UTF-8"?>

<metamorph xmlns="http://www.culturegraph.org/metamorph" version="1">

	<vars>
		<var name="swissbib_domain" value="http://data.swissbib.ch/resource/"/>
	</vars>


	<macros>
		<macro name="context">
			<!-- Writes JSON-LD context -->
			<entity name="@context" flushWith="record">

				<data name="bf" source="_id">
					<constant value="http://bibframe.org/vocab/" />
				</data>

				<data name="rdfs" source="_id">
					<constant value="http://www.w3.org/2000/01/rdf-schema#" />
				</data>

				<data name="dbp" source="_id">
					<constant value="http://dbpedia.org/ontology/" />
				</data>

				<data name="rdau" source="_id">
					<constant value="http://rdaregistry.info/Elements/u/" />
				</data>

				<data name="dct" source="_id">
					<constant value="http://purl.org/dc/terms/" />
				</data>

				<data name="rdf" source="_id">
					<constant value="http://www.w3.org/1999/02/22-rdf-syntax-ns#" />
				</data>

				<data name="foaf" source="_id">
					<constant value="http://xmlns.com/foaf/0.1/" />
				</data>

				<data name="bibo" source="_id">
					<constant value="http://purl.org/ontology/bibo/" />
				</data>

				<data name="dc" source="_id">
					<constant value="http://purl.org/dc/elements/1.1/" />
				</data>

				<data name="skos" source="_id">
					<constant value="http://www.w3.org/2004/02/skos/core#" />
				</data>

			</entity>
		</macro>
	</macros>


	<rules>

		<!-- Set id -->
		<data source="001" name="_id">
			<compose prefix="http://data.swissbib.ch/resource/"/>
		</data>

		<!-- Definitions for recursions to be used later in substructures (must be set here!) -->

		<data source="001" name="@swissbib_id">
			<compose prefix="http://data.swissbib.ch/resource/"/>
		</data>
		<data source="008" name="@language">
			<substring  start="35"  end="38"/>
		</data>

		<combine name="@key1000" value="${name}##${number}##${title}##${lifedata}##${fullname}" flushWith="1000 ">
			<data source="1000 .a" name="name" />
			<data source="1000 .b" name="number" />
			<data source="1000 .c" name="title" />
			<data source="1000 .d" name="lifedata" />
			<data source="1000 .q" name="fullname" />
			<postprocess>
				<java class="org.swissbib.linked.mf.morph.functions.AuthorHash"/>
			</postprocess>
		</combine>
		<combine name="@key1001" value="${lastname}##${firstname}##${number}##${title}##${lifedata}##${fullname}" flushWith="1001 ">
			<data source="1001 .a" name="lastname" />
			<data source="1001 .D" name="firstname" />
			<data source="1001 .b" name="number" />
			<data source="1001 .c" name="title" />
			<data source="1001 .d" name="lifedata" />
			<data source="1001 .q" name="fullname" />
			<postprocess>
				<java class="org.swissbib.linked.mf.morph.functions.AuthorHash"/>
			</postprocess>
		</combine>
		<combine name="@key7000" value="${name}##${number}##${title}##${lifedata}##${fullname}" flushWith="7000 ">
			<data source="7000 .a" name="name" />
			<data source="7000 .b" name="number" />
			<data source="7000 .c" name="title" />
			<data source="7000 .d" name="lifedata" />
			<data source="7000 .q" name="fullname" />
			<postprocess>
				<java class="org.swissbib.linked.mf.morph.functions.AuthorHash"/>
			</postprocess>
		</combine>
		<combine name="@key7001" value="${lastname}##${firstname}##${number}##${title}##${lifedata}##${fullname}" flushWith="7001 ">
			<data source="7001 .a" name="lastname" />
			<data source="7001 .D" name="firstname" />
			<data source="7001 .b" name="number" />
			<data source="7001 .c" name="title" />
			<data source="7001 .d" name="lifedata" />
			<data source="7001 .q" name="fullname" />
			<postprocess>
				<java class="org.swissbib.linked.mf.morph.functions.AuthorHash"/>
			</postprocess>
		</combine>
		<combine name="@key710" value="${name}##${subunit}##${number}##${date}##${location}" flushWith="710??">
			<data source="710??.a" name="name" />
			<data source="710??.b" name="subunit" />
			<data source="710??.n" name="number" />
			<data source="710??.d" name="date" />
			<data source="710??.c" name="location" />
			<postprocess>
				<java class="org.swissbib.linked.mf.morph.functions.AuthorHash"/>
			</postprocess>
		</combine>
		<combine name="@key711" value="${name}##${subunit}##${number}##${date}##${location}" flushWith="711??">
			<data source="710??.a" name="name" />
			<data source="710??.e" name="subunit" />
			<data source="710??.n" name="number" />
			<data source="710??.d" name="date" />
			<data source="710??.c" name="location" />
			<postprocess>
				<java class="org.swissbib.linked.mf.morph.functions.AuthorHash"/>
			</postprocess>
		</combine>

		<!--BUILD BULK API HEADER FOR TYPE "DOCUMENT"-->

		<!--BUILD THE RECORD "ABOUT"-->

<!--		<entity name="&#45;&#45;" flushWith="record" >-->
			<!--To define the subject (root element) of each record.
			"entity" makes it possible to create a hierarchical tag structure.
			"flushWith" enables to group various subfields into one output, even if the field appears more than one time. -->

			<!-- Integrate JSON-LD context -->
			<call-macro name="context" />

			<data source="@swissbib_id" name="@id" >
				<compose postfix="/about" />
			</data>

			<!--PUBLICATION DATE OF THE RDF RECORD-->
			<entity name="dct:issued">
				<data name="@type" source="_id">
					<!--The symbol '~' before rdf:about is very important: it permits to integrate rdf:about as an attribute in the tag rdf:Description-->
					<!-- compare http://b3e.net/metamorph-book/latest/datamodel.html
                        section "Strukturierte Literal- und EntitÃ¤tsnamen"
                        about the possibilities and background for the chosen design and implementation provided by the Metamorph datamodel
                        to express structured data elements (like XML attributes or list elements)
                        and data types
                    -->
					<constant value="http://www.w3.org/2001/XMLSchema#dateTime"/>
				</data>
				<data name="@value" source="_id">
					<timestamp format="yyyy-MM-dd'T'HH:mm:ss.SSSXXX" />
				</data>
			</entity>

			<!--LAST MODIFICATION DATE OF THE MARC RECORD-->
			<entity name="dct:modified">
				<data name="@type" source="_id">
					<constant value="http://www.w3.org/2001/XMLSchema#dateTime"/>
				</data>
				<data name="@value" source="005">
					<regexp match="^(\d\d\d\d)(\d\d)(\d\d)(\d\d)(\d\d)(\d\d)\.(\d)" format="${1}-${2}-${3}T${4}:${5}:${6}+01:00"/>
				</data>
			</entity>

			<!--NETWORK(S) THAT CREATED THE RECORD-->
			<entity name="dct:contributor">
				<data source="035  .a" name="dct:contributor">
					<regexp match="\((.*)\)" format="${1}" />
					<lookup in="networks"/>
					<unique part="value" />
				</data>
			</entity>

			<data source="035  .a" name="dc:contributor">
			<!--rule for the case where the network is not in the lookup here above-->
				<regexp match="\((.*)\)" format="${1}" />
				<blacklist>
					<entry name="ABN" /><entry name="ALEX" /><entry name="BGR" /><entry name="CCSA" /><entry name="CH-CCSA" /><entry name="DDB" /><entry name="DE-599" /><entry name="ECOD" /><entry name="IDSBB" /><entry name="IDSLU" /><entry name="IDSSG" /><entry name="IDSSG2" /><entry name="LIBIB" /><entry name="NEBIS" /><entry name="OCoLC" /><entry name="RERO" /><entry name="RETROS" /><entry name="SBT" /><entry name="SERVAL" /><entry name="SGBN" /><entry name="SLB" /><entry name="SNL" /><entry name="Sz" /><entry name="ZORA" />
				</blacklist>
			</data>

			<!--LINK WITH THE BASIS RECORD-->
			<entity name="foaf:primaryTopic" >
				<data source="@swissbib_id" name="@id" />
			</entity>


<!--		</entity>-->
	</rules>

	<maps>
		<filemap name="cantons" files="./src/main/resources/transformation/resource/maps/cantons.txt" separator="\t"/>
		<filemap name="languages" files="./src/main/resources/transformation/resource/maps/languages.txt" separator="\t"/>
		<filemap name="countries" files="./src/main/resources/transformation/resource/maps/countries.txt" separator="\t"/>
		<filemap name="networks" files="./src/main/resources/transformation/resource/maps/networks.txt" separator="\t"/>
		<filemap name="type_content" files="./src/main/resources/transformation/resource/maps/type_content.txt" separator="\t"/>
		<filemap name="type_media" files="./src/main/resources/transformation/resource/maps/type_media.txt" separator="\t"/>
	</maps>

</metamorph>
