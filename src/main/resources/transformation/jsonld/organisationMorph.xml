<?xml version="1.0" encoding="UTF-8"?>

<metamorph xmlns="http://www.culturegraph.org/metamorph" version="1">

	<vars>
		<var name="swissbib_domain" value="http://data.swissbib.ch/resource/"/>
	</vars>

	<macros>
		<macro name="bulk-header">
			<!-- Writes header line as required by the Elasticsearch Bulk API -->
			<entity name="index" flushWith="$[fw]">

				<data name="_type" source="$[id]">
					<constant value="organisation"/>
				</data>

				<data name="_id" source="$[id]" />

				<data name="_index" source="$[id]">
					<constant value="testsb"/>
				</data>

			</entity>
		</macro>
	</macros>

	<rules>

		<combine name="@key710" value="${name}##${subunit}##${number}##${date}##${location}" flushWith="710??">
			<data source="710??.a" name="name" />
			<data source="710??.b" name="subunit" />
			<data source="710??.n" name="number" />
			<data source="710??.d" name="date" />
			<data source="710??.c" name="location" />
			<postprocess>
				<java class="org.swissbib.linked.mf.morph.functions.AuthorHash"/>
			</postprocess>
		</combine>
		<combine name="@key711" value="${name}##${subunit}##${number}##${date}##${location}" flushWith="711??">
			<data source="710??.a" name="name" />
			<data source="710??.e" name="subunit" />
			<data source="710??.n" name="number" />
			<data source="710??.d" name="date" />
			<data source="710??.c" name="location" />
			<postprocess>
				<java class="org.swissbib.linked.mf.morph.functions.AuthorHash"/>
			</postprocess>
		</combine>
	
		<!--BUILD THE BASIS RECORD -->

		<call-macro name="bulk-header" fw="710??" id="@key710" />
		<!--710-->
		<entity name="--" flushWith="710??" >
			<data name="@id" source="@key710" >
				<compose prefix="http://data.swissbib.ch/organisation/" />
			</data>
			<concat name="rdfs:label" delimiter="" flushWith="710??" reset="true" sameEntity="true" >
				<data source="710??.a" >
					<regexp match="(.*[^\.$])" format="${1}" />
					<!--This regex matches everything except the eventual final dot.-->
				</data>
				<data source="710??.b" >
					<regexp match="(.*[^\.$])" format="${1}" />
					<compose prefix=". " />
				</data>
				<data source="710??.c" >
					<compose prefix=" " />
				</data>
				<data source="710??.d" >
					<compose prefix=" " />
				</data>
				<data source="710??.n" >
					<compose prefix=" " />
				</data>
			</concat>
		</entity>
		
		<call-macro name="bulk-header" fw="711??" id="@key711" />
		<!--711-->
		<entity name="--" flushWith="711??" >
			<data name="@id" source="@key711" >
				<compose prefix="http://data.swissbib.ch/organisation/" />
			</data>
			<concat name="rdfs:label" delimiter="" flushWith="711??" reset="true" sameEntity="true" >
				<data source="711??.a" >
					<regexp match="(.*[^\.$])" format="${1}" />
				</data>
				<data source="711??.c" >
					<compose prefix=" " />
				</data>
				<data source="711??.d" >
					<compose prefix=" " />
				</data>
				<data source="711??.e" >
					<regexp match="(.*[^\.$])" format="${1}" />
					<compose prefix=". " />
				</data>
				<data source="711??.n" >
					<compose prefix=" " />
				</data>
			</concat>
		</entity>
		
	</rules>

</metamorph>
