<?xml version="1.0" encoding="UTF-8"?>

<metamorph xmlns="http://www.culturegraph.org/metamorph" version="1">


	<rules>
		
		<!--RECURSION-->
		
		<data source="001" name="@idnr" />
		
		<!--ITEM-->

		<entity name="bf:HeldItem" flushWith="949??" >
			
			<!--ID OF THE ITEM
			    The ID of the records from BORIS, ECOD, RETROS, SERVAL and ZORA have different rules, because they come from subfield $E and not $p.
			-->
			
			<combine name="rdf:about" value="http://data.swissbib.ch/item/${network}-${item_id}" flushWith="949??" sameEntity="true" >
				<if>
					<data source="949??.B">
						<blacklist>
							<entry name="BORIS"/><entry name="ECOD"/><entry name="RETROS"/><entry name="SERVAL"/><entry name="ZORA"/>
						</blacklist>
					</data>
				</if>
				<data source="949??.p" name="item_id" />
				<data source="949??.B" name="network" />
			</combine>
			<!--BORIS, RETROS, ZORA-->
			<combine name="rdf:about" value="http://data.swissbib.ch/item/${network}-${item_id}" flushWith="949??" sameEntity="true" >
				<if>
					<data source="949??.B">
						<whitelist>
							<entry name="BORIS"/><entry name="RETROS"/><entry name="ZORA"/>
						</whitelist>
					</data>
				</if>
				<data source="949??.E" name="item_id" >
					<regexp match="\.ch\:(.*)" format="${1}"/>
				</data>
				<data source="949??.B" name="network" />
			</combine>
			<!--ECOD, SERVAL-->
			<combine name="rdf:about" value="http://data.swissbib.ch/item/${network}-${item_id}" flushWith="949??" sameEntity="true" >
				<if>
					<data source="949??.B">
						<whitelist>
							<entry name="ECOD"/><entry name="SERVAL"/>
						</whitelist>
					</data>
				</if>
				<data source="949??.E" name="item_id" />
				<data source="949??.B" name="network" />
			</combine>
			
			<!--LINK WITH BILIOGRAPHICAL RESOURCE-->			
			
			<combine name="bf:holdingFor" value="http://data.swissbib.ch/resource/${id_record}" flushWith="949??" >
				<data source="@idnr" name="id_record" />
			</combine>
			
			<!--LINK TO ITEM IN THE LOCAL LIBRARY INTERFACE-->
			
			<combine name="collectItemValues" value="${949B}##${949b}##${949F}##${949E}##${idnr}##${035Ids}" flushWith="949??">

				<concat name="035Ids" delimiter="!!" flushWith="035??" reset="false">
					<data source="035??.a" />
				</concat>

				<data source="949??.B" name="949B"/> <!-- network e.g. IDSBB / NEBIS etc-->
				<data source="949??.b" name="949b"/> <!-- institution code eg. A100 UB Basel -->
				<data source="949??.F" name="949F"/> <!-- institution_chb special value created because of organizational reasons we shouldn't take care at the moment-->
				<data source="949??.E" name="949E"/> <!--bibsysnumber -->
				<data source="@idnr" name="idnr"/> <!-- swissbib record id used -->
				<data source="@035Ids" name="035Ids"/> <!-- bib system numbers -->

				<postprocess>
					<java class="org.swissbib.linked.mf.morph.functions.ItemLink"/>
				</postprocess>
			</combine>
			
			<!--SHELFMARK-->
			
			<concat name="bibo:locator" delimiter="" flushWith="949??" reset="true" >
				<data source="949??.j" />
				<data source="949??.s" >
					<compose prefix=" " />
				</data>
			</concat>
			
			<!--LIBRARY-->
			
			<combine name="bibo:owner" value="http://data.swissbib.ch/organisation/${network}${library_id}" flushWith="949??" sameEntity="true" >
				<data source="949??.b" name="library_id" >
					<blacklist>
						<!--Doesn't consider the REPO libraries for this part, because their URI consist of one part only:-->
						<entry name="BORIS"/><entry name="ECOD"/><entry name="RETROS"/><entry name="SERVAL"/><entry name="ZORA"/>
					</blacklist>
					<compose prefix="-" />
				</data>
				<data source="949??.B" name="network" />
			</combine>
			
			<!--SUBLOCATION WITHIN THE LIBRARY-->	
			
			<data source="949??.1" name="bf:subLocation" />
			
		</entity>

	</rules>


</metamorph>
